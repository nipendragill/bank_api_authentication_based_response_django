version: 2
jobs:
    build:
      docker:
          - image: circleci/python:3.6.4
            environment:
              PIPENV_VENV_IN_PROJECT: true
              DATABASE_URL: postgresql://root@localhost/circle_test?sslmode=disable
          - image: circleci/postgres:9.6.2 # an example of how to specify a service container
            environment:
               POSTGRES_USER: postgres
               POSTGRES_DB: db1
      working_directory: ~/bank_api_authentication_based_response_django
    
      steps:
        - checkout
        - run: sudo chown -R circleci:circleci /usr/local/bin
        - run: sudo chown -R circleci:circleci /usr/local/lib/python3.6/site-packages
        - restore_cache:  # ensure this step occurs *before* installing dependencies
            key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
        - run:
            command: |
              sudo pip install pipenv
              pipenv install
        - save_cache:
            key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
            paths:
              - ".venv"
              - "/usr/local/bin"
              - "/usr/local/lib/python3.6/site-packages"
        - run:
          name: run commands for test cases
          command: |
            pipenv run python manage.py test
